require("dotenv").config({
  path: __dirname + "server/.env",
});

const express = require("express");
const bodyParser = require("body-parser");
const path = require("path");
const cookieParser = require("cookie-parser");

var Request = require("tedious").Request;

const jwt = require("jsonwebtoken");
const bcrypt = require("bcryptjs");

const connection = require("./server/db-conn");

const withAuth = require("./server/auth_middleware");

/* JWT secret */
const secret = process.env.JWT_SECRET;
console.log(secret);

const executeQuery = (query) => {
  console.log(`Going to execute query ${query}`);
  request = new Request(query, (err, rowCount) => {
    if (err) {
      console.log(err);
    } else {
      console.log(rowCount + "rows");
    }
  });

  request.on("row", (cols) => {
    cols.forEach((col) => {
      if (col.value == null) {
        console.log("NULL");
      } else {
        console.log(col.value);
      }
    });
  });

  connection.execSql(request);
};

const app = express();
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: false }));
app.use(cookieParser());

// give server access to static files generated by npm build in client folder
app.use(express.static("./client/dist/"));

/* Declare Routes  ============================== */

/* REGISTER route */
app.post("/api/register", (req, res) => {
  const { username, password } = req.body;
  console.log(`REGISTER: Got request: ${username}, ${password}`);

  if (username === undefined || password === undefined) {
    res.status(400).send("Invalid parameters for registration");
  } else {
    bcrypt.hash(password, 10, (err, hash) => {
      if (err) {
        throw err;
      } else {
        var query = `INSERT INTO [dbo].[User] (Username, Password) VALUES ('${username}', '${hash}');`;
        executeQuery(query);
        res.status(200).send(`Welcome to the club, ${username}!`);
      }
    });
  }
});

/* AUTHENTICATE route */
app.post("/api/authenticate", (req, res) => {
  const { username, password } = req.body;
  console.log(`AUTH: Got request: ${username}, ${password}`);

  if (username === undefined || password === undefined) {
    res.status(401).send("Invalid parameters for authentication");
  } else {
    var query = `SELECT Password FROM [dbo].[User] WHERE Username='${username}'`;

    console.log(`Going to execute query ${query}`);
    request = new Request(query, (err, rowCount) => {
      if (err) {
        console.error(err);
      } else {
        if (rowCount === 0) {
          res.status(401).send("Login failure!");
        }
        console.log(`Got ${rowCount} rows`);
      }
    });

    request.on("row", (cols) => {
      cols.forEach((col) => {
        if (col.value == null) {
          console.log("Got NULL value");
        } else {
          bcrypt.compare(password, col.value, (err, result) => {
            if (err) {
              throw err;
            } else {
              console.log(result);
              if (result) {
                console.log("Password Check OK. Issuing Token");
                const payload = { username };
                const token = jwt.sign(payload, secret, {
                  expiresIn: "1h",
                });
                res.cookie("token", token, { httpOnly: true }).sendStatus(200);
              } else {
                res.status(401).send("Login failure!");
              }
            }
          });
        }
      });
    });

    connection.execSql(request);
  }
});

app.get("/api/logout", (req, res) => {
  res.clearCookie('token');
  res.sendStatus(200);
})


app.post("/api/personalInfo", withAuth, (req, res) => {
  var query = 
  `ALTER TABLE[dbo].[SensitiveInfo]
    SET FirstName = ,
    SET LastName = ,
    SET Address = ,
    SET PersonalEmail = ,
    SET PhoneNumber = ,
  WHERE ID = (SELECT 
                SI.ID 
              FROM[dbo].[User] U
              INNER JOIN[dbo].[Referee] R
                ON R.UserID = U.ID
              INNER JOIN[dbo].[SensitiveInfo] SI
                ON R.SensitiveInfoID = SI.ID
              WHERE U.Username = '${username}')`
});

/* JSON format: {username: rares} */
app.get("/api/personalInfo", withAuth, (req, res) => {
  const username = req.query.username;
  console.log(`FETCH_PERSONAL_INFO: Got request: ${username}`);

  if (username === undefined) {
    res.status(401).send("Invalid parameters for authentication");
  } else {
    var query =
    `SELECT
        Usr.Username,
        Cnt.Name as Judet,
        L.Name as Lot,
        Cat.Name as Categorie,
        SI.LastName as Nume,
        SI.FirstName as Prenume,
        SI.Address as Adresa,
        SI.PersonalEmail as Email,
        SI.PhoneNumber as Telefon
    FROM [dbo].[User] Usr
    INNER JOIN [dbo].[Referee] Ref
        ON Ref.UserID = Usr.ID
    INNER JOIN [dbo].[County] Cnt
        ON Ref.CountyID = Cnt.ID
    INNER JOIN [dbo].[Lot] L
        ON Ref.LotID = L.ID
    INNER JOIN [dbo].[Category] Cat
        ON Ref.CategoryID = Cat.ID
    INNER JOIN [dbo].[SensitiveInfo] SI
        ON Ref.SensitiveInfoID = SI.ID
    WHERE Usr.Username='${username}'`;

    console.log(`Going to execute query ${query}`);
    request = new Request(query, (err, rowCount) => {
      if (err) {
        console.error(err);
        res.status(400).send("User information not in database!");
      } else {
        console.log(`Got ${rowCount} rows`);
      }
    });

    request.on("row", (cols) => {
      let obj = {};
      cols.forEach((col) => {
        obj[col.metadata.colName] = col.value;
      });
      console.log(`Sending ${JSON.stringify(obj)}`);
      res.status(200).send(JSON.stringify(obj));
    });

    connection.execSql(request);
  }
});

/* Route for knowing if the cookie is valid */
app.get("/checkToken", withAuth, (req, res) => {
  res.sendStatus(200);
});

app.get("/*", (req, res) => {
  res.sendFile("index.html", {
    root: path.join(__dirname, "client", "dist"),
  });
});

connection.on("connect", function (err) {
  if (err) {
    console.error(`Failed to connect to remote database due to ${err}`);
  } else {
    console.log("Successfully connected to database!");
  }
});

connection.connect();

// console.log that your server is up and running
const port = process.env.PORT || 5001;
app.listen(port, () => console.log(`Listening on port ${port}`));
